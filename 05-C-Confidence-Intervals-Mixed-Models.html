<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Confidence Intervals for Mixed Models</title>

<script src="site_libs/header-attrs-2.28/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.13.2/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="style.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}

.tocify-subheader {
  display: inline;
}
.tocify-subheader .tocify-item {
  font-size: 0.95em;
}

</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html"></a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Data Exploration
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="01-A-data-exploration.html">Lab</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Linear Models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="02-A-linear-models-and-probability-distributions.html">Lab</a>
    </li>
    <li>
      <a href="02-B-Homework-01.html">Homework 1</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Model Selection
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="03-A-model-selection.html">Lab</a>
    </li>
    <li>
      <a href="03-B-Homework-02.html">Homework 2</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Autocorrelation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="04-A-Autocorrelation.html">Lab</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Mixed Models
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="05-A-Linear-Mixed-Models.html">Lab: Linear Mixed Models</a>
    </li>
    <li>
      <a href="05-B-Generalized-Linear-Mixed-Models.html">Lab: Generalized Linear Mixed Models</a>
    </li>
    <li>
      <a href="05-C-Confidence-Intervals-Mixed-Models.html">Lab: Confidence Intervals for Mixed Models</a>
    </li>
    <li>
      <a href="05-C-Homework-03.html">Homework 3</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    HGAMs
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="06-A-Hierarchical-Generalized-Additive-Models.html">Lab: HGAMs</a>
    </li>
    <li>
      <a href="06-B-Homework-04.html">Homework 4</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Hello, Bayes!
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="07-A-Homework-05.html">Homeork 5</a>
    </li>
    <li>
      <a href="07-B-HelloBayes.html">Lab: Hello, Bayes!</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Confidence Intervals for Mixed Models</h1>

</div>


<p><strong>Assigned Reading:</strong></p>
<ul>
<li>Shipley, J. R., Twining, C. W., Taff, C. C., Vitousek, M. N., &amp;
Winkler, D. W. (2022). Selection counteracts developmental plasticity in
body-size responses to climate change. Nature Climate Change, 12(9),
863-868.</li>
<li>Christensen, S. A., Ruder, M. G., Williams, D. M., Porter, W. F.,
&amp; Stallknecht, D. E. (2020). The role of drought as a determinant of
hemorrhagic disease in the eastern United States. Global Change Biology,
26(7), 3799-3808.</li>
</ul>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>We’ll continue to look at Linear and Generalized linear mixed effects
models, emphasizing how to get confidence intervals on the predictions.
To do that, we’ll use our new friend: the bootstrapping method. Below is
an example of bootstrapping used to estimate confidence intervals for
the analysis in the assigned Shipley et al. (2022) paper:</p>
<p>
<img
src="https://github.com/LivingLandscapes/Course_EcologicalModeling/raw/master/images/Shipley2022Bootstrap.jpg"
width="600" />
<p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co"># List of packages necessary to run this script:</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">require</span>(librarian, <span class="at">quietly =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(librarian)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">shelf</span>(tidyverse, broom.mixed, broom, lme4, boot, snow, here,</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>      <span class="at">lib =</span> <span class="fu">tempdir</span>())</span></code></pre></div>
<pre><code>## package &#39;snow&#39; successfully unpacked and MD5 sums checked
## 
## The downloaded binary packages are in
##  C:\Users\cr065\AppData\Local\Temp\RtmpgfBDT0\downloaded_packages</code></pre>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># Set seed</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">7871</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"># Set the web address where R will look for files from this repository</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"># Do not change this address</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>repo_url <span class="ot">&lt;-</span> <span class="st">&quot;https://raw.githubusercontent.com/LivingLandscapes/Course_EcologicalModeling/master/&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co"># Load data</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>ecervi <span class="ot">&lt;-</span> </span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  <span class="fu">read.table</span>(<span class="fu">paste0</span>(repo_url, <span class="st">&quot;/data/DeerEcervi.txt&quot;</span>), </span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>             <span class="at">header =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
</div>
<div id="confidence-intervals-for-lmms" class="section level2">
<h2>Confidence intervals for LMMs</h2>
<p>We’ll start with something easy - a linear mixed effects model with
the sleepstudy data.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>ssBase <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(sleepstudy, <span class="fu">aes</span>(<span class="at">x =</span> Days, <span class="at">y =</span> Reaction)) <span class="sc">+</span> </span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">color=</span>Subject)) <span class="sc">+</span> </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">scale_color_discrete</span>() <span class="sc">+</span> </span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">x=</span><span class="st">&quot;Days with no sleep&quot;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>       <span class="at">y=</span><span class="st">&quot;Reaction time [ms]&quot;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>ssBase <span class="sc">+</span> <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">&quot;lm&quot;</span>)<span class="sc">+</span> <span class="fu">facet_wrap</span>(<span class="sc">~</span>Subject) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/PrepareData-1.png" width="672" /></p>
<p>So there’s the basic data, and now we fit a mixed model with both the
intercept and Days varying across subjects.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># fit a mixed model</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="fu">summary</span>(ss.mm <span class="ot">&lt;-</span> <span class="fu">lmer</span>(Reaction <span class="sc">~</span> Days <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">+</span> Days <span class="sc">|</span> Subject),</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>                      sleepstudy,<span class="at">REML=</span><span class="cn">FALSE</span>))</span></code></pre></div>
<pre><code>## Linear mixed model fit by maximum likelihood  [&#39;lmerMod&#39;]
## Formula: Reaction ~ Days + (1 + Days | Subject)
##    Data: sleepstudy
## 
##      AIC      BIC   logLik deviance df.resid 
##   1763.9   1783.1   -876.0   1751.9      174 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.9416 -0.4656  0.0289  0.4636  5.1793 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev. Corr
##  Subject  (Intercept) 565.48   23.780       
##           Days         32.68    5.717   0.08
##  Residual             654.95   25.592       
## Number of obs: 180, groups:  Subject, 18
## 
## Fixed effects:
##             Estimate Std. Error t value
## (Intercept)  251.405      6.632  37.907
## Days          10.467      1.502   6.968
## 
## Correlation of Fixed Effects:
##      (Intr)
## Days -0.138</code></pre>
<p>Let’s check the profile confidence limits on the estimates before we
look at getting confidence limits on predictions.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># remember this is SLOOOOW</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#ss.parms &lt;- tidy(ss.mm, conf.int=TRUE, conf.method=&quot;profile&quot;)</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co"># unfortunately tidy.merMod doesn&#39;t do profile intervals</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">confint</span>(ss.mm, <span class="at">oldNames =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<pre><code>##                                    2.5 %      97.5 %
## sd_(Intercept)|Subject        14.3814916  37.7160187
## cor_Days.(Intercept)|Subject  -0.4815004   0.6849861
## sd_Days|Subject                3.8011648   8.7533667
## sigma                         22.8982662  28.8579973
## (Intercept)                  237.6806955 265.1295147
## Days                           7.3586533  13.5759187</code></pre>
<p>So the most interesting thing here is that the confidence limit for
the correlation coefficient includes 0. The other thing to recognize is
that all of the variance parameters are uncertain as well. Even the
<em>residual variance</em> has a range of possible values! This is the
uncertainty that is not easy to include in our confidence intervals on
predictions.</p>
<p>What I want to do now is get confidence intervals on predicted values
so we can add nice confidence polygons to our predicted plots. Unlike
<code>glm()</code> or <code>lm()</code> objects, the predict function
for <code>merMod</code> objects produced by <code>(g)lmer()</code>
doesn’t give us standard errors or confidence limits. The reason given
by the developers is that there isn’t a clear method to account for the
variance in the random effects parameters. Recognizing that these
parameters are uncertain would increase the width of the confidence
intervals on our predictions.</p>
<p>First I want to make a plot that has both the population level fitted
values and the subject level lines. This is going to get messy.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co"># get fitted values</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>ss.fitted <span class="ot">&lt;-</span> broom.mixed<span class="sc">::</span><span class="fu">augment</span>(ss.mm)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="fu">names</span>(ss.fitted)</span></code></pre></div>
<pre><code>##  [1] &quot;Reaction&quot; &quot;Days&quot;     &quot;Subject&quot;  &quot;.fitted&quot;  &quot;.resid&quot;   &quot;.hat&quot;    
##  [7] &quot;.cooksd&quot;  &quot;.fixed&quot;   &quot;.mu&quot;      &quot;.offset&quot;  &quot;.sqrtXwt&quot; &quot;.sqrtrwt&quot;
## [13] &quot;.weights&quot; &quot;.wtres&quot;</code></pre>
<p><code>augment()</code> gives us a bunch of columns for merMod
objects; the one we’re interested in here is <code>.fitted</code>. There
is also a column <code>.mu</code> that has identical values in it. For a
model that has a link function other than the identity link (e.g. the
default logit link for the binomial family) <code>.fixed</code> will be
on the <em>link</em> scale, and <code>.mu</code> will be on the
<em>response</em> scale. We’ll come back to that in the next
example.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># x is inherited from ssBase</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co"># if we don&#39;t specify color=Subject in geom_line()</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co"># we only get one line ... oh, because I specified color=Subject</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co"># in geom_points() not ggplot()</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>ssBase <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted, <span class="at">color=</span>Subject), <span class="at">data=</span>ss.fitted) <span class="sc">+</span> <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/messyPlot1-1.png" width="672" /></p>
<p>So each line represents the fitted values including the effects of
the random perturbations on the intercept and slope. Now get the
population level predictions using predict() and a new data.frame.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">Days=</span><span class="dv">0</span><span class="sc">:</span><span class="dv">9</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co"># re.form tells predict what to do with the random effects</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co"># ~0 says ignore them; population level predictions</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>nd<span class="sc">$</span>PopPred <span class="ot">&lt;-</span> <span class="fu">predict</span>(ss.mm, <span class="at">newdata=</span>nd, <span class="at">re.form=</span><span class="sc">~</span><span class="dv">0</span>)</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>ssBase <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted, <span class="at">color=</span>Subject), <span class="at">data=</span>ss.fitted, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>PopPred), <span class="at">data=</span>nd, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="figure">
<img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/popPredictions-1.png" alt="Reaction time as a function of days without sleep. Fine lines are subject level fitted values, thick black line is the population level prediction." width="672" />
<p class="caption">
Reaction time as a function of days without sleep. Fine lines are
subject level fitted values, thick black line is the population level
prediction.
</p>
</div>
<p>OK, but we want to know how much confidence to have in that
prediction. Really the only option here is to use bootstrapping. This is
slow, but gets all the uncertainty in our prediction. Fortunately
<code>lme4</code> includes a function <code>bootMer</code> to do
bootstrapping by generating a random sample of data and then fitting the
model to that new data. Repeat that 1000’s of times and you can get a
distribution of possible model fits. Unfortunately we have to write a
function to extract the predictions from the random samples the way we
want them. Start by getting a single random sample.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># bootMer takes a fitted merMod object</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="co"># then the function that takes a fitted merMod object and returns the thing we want as a vector</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co"># fitted() will give us the coefficients from a fit</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(ss.mm, fixef)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co"># a (fairly) compact look at the *str*ucture of an object</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="fu">str</span>(test)</span></code></pre></div>
<pre><code>## List of 10
##  $ t0       : Named num [1:2] 251.4 10.5
##   ..- attr(*, &quot;names&quot;)= chr [1:2] &quot;(Intercept)&quot; &quot;Days&quot;
##  $ t        : num [1, 1:2] 249.5 10.6
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:2] &quot;(Intercept)&quot; &quot;Days&quot;
##  $ R        : int 1
##  $ data     :&#39;data.frame&#39;:   180 obs. of  3 variables:
##   ..$ Reaction: num [1:180] 250 259 251 321 357 ...
##   ..$ Days    : num [1:180] 0 1 2 3 4 5 6 7 8 9 ...
##   ..$ Subject : Factor w/ 18 levels &quot;308&quot;,&quot;309&quot;,&quot;310&quot;,..: 1 1 1 1 1 1 1 1 1 1 ...
##   ..- attr(*, &quot;terms&quot;)=Classes &#39;terms&#39;, &#39;formula&#39;  language Reaction ~ Days + (1 + Days + Subject)
##   .. .. ..- attr(*, &quot;variables&quot;)= language list(Reaction, Days, Subject)
##   .. .. ..- attr(*, &quot;factors&quot;)= int [1:3, 1:2] 0 1 0 0 0 1
##   .. .. .. ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. .. .. .. ..$ : chr [1:3] &quot;Reaction&quot; &quot;Days&quot; &quot;Subject&quot;
##   .. .. .. .. ..$ : chr [1:2] &quot;Days&quot; &quot;Subject&quot;
##   .. .. ..- attr(*, &quot;term.labels&quot;)= chr [1:2] &quot;Days&quot; &quot;Subject&quot;
##   .. .. ..- attr(*, &quot;order&quot;)= int [1:2] 1 1
##   .. .. ..- attr(*, &quot;intercept&quot;)= int 1
##   .. .. ..- attr(*, &quot;response&quot;)= int 1
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##   .. .. ..- attr(*, &quot;predvars&quot;)= language list(Reaction, Days, Subject)
##   .. .. ..- attr(*, &quot;dataClasses&quot;)= Named chr [1:3] &quot;numeric&quot; &quot;numeric&quot; &quot;factor&quot;
##   .. .. .. ..- attr(*, &quot;names&quot;)= chr [1:3] &quot;Reaction&quot; &quot;Days&quot; &quot;Subject&quot;
##   .. .. ..- attr(*, &quot;predvars.fixed&quot;)= language list(Reaction, Days)
##   .. .. ..- attr(*, &quot;varnames.fixed&quot;)= chr [1:2] &quot;Reaction&quot; &quot;Days&quot;
##   .. .. ..- attr(*, &quot;predvars.random&quot;)= language list(Reaction, Days, Subject)
##   ..- attr(*, &quot;formula&quot;)=Class &#39;formula&#39;  language Reaction ~ Days + (1 + Days | Subject)
##   .. .. ..- attr(*, &quot;.Environment&quot;)=&lt;environment: R_GlobalEnv&gt; 
##  $ seed     : int [1:626] 10403 432 -1582529988 2053175058 -1014989811 -156092601 32191790 495494280 -620179061 -274560663 ...
##  $ statistic:function (object, ...)  
##  $ sim      : chr &quot;parametric&quot;
##  $ call     : language bootMer(x = ss.mm, FUN = fixef)
##  $ ran.gen  : chr &quot;simulate(&lt;lmerMod&gt;, 1, *)&quot;
##  $ mle      :List of 3
##   ..$ beta : num [1:2] 251.4 10.5
##   ..$ theta: Named num [1:3] 0.9292 0.0182 0.2226
##   .. ..- attr(*, &quot;names&quot;)= chr [1:3] &quot;Subject.(Intercept)&quot; &quot;Subject.Days.(Intercept)&quot; &quot;Subject.Days&quot;
##   ..$ sigma: num 25.6
##  - attr(*, &quot;class&quot;)= chr [1:2] &quot;bootMer&quot; &quot;boot&quot;
##  - attr(*, &quot;bootFail&quot;)= int 0
##  - attr(*, &quot;boot.all.msgs&quot;)=List of 3
##   ..$ factory-message: &#39;table&#39; int[0 (1d)] 
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. .. ..$ : NULL
##   ..$ factory-warning: &#39;table&#39; int[0 (1d)] 
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. .. ..$ : NULL
##   ..$ factory-error  : &#39;table&#39; int[0 (1d)] 
##   .. ..- attr(*, &quot;dimnames&quot;)=List of 1
##   .. .. ..$ : NULL
##  - attr(*, &quot;boot_type&quot;)= chr &quot;boot&quot;</code></pre>
<p>There’s alot of stuff in there, most of which relates to internal
stuff that would allow us to recreate the simulation. We are mostly
interested in <code>t0</code> and <code>t</code>. <code>t0</code> is the
result of applying our FUN to the original object. In this case it gives
us a vector of the fixed effects coefficients. <code>t</code> is a
matrix of the simulation output. In each row is the result of our FUN
applied to a simulated result. By default <code>bootMer</code> only does
one simulation. If we want more:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(ss.mm, fixef, <span class="at">nsim=</span><span class="dv">10</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>test<span class="sc">$</span>t</span></code></pre></div>
<pre><code>##       (Intercept)      Days
##  [1,]    253.6133 11.429613
##  [2,]    240.6025 10.097065
##  [3,]    249.0604 12.279100
##  [4,]    249.2493 10.150127
##  [5,]    250.2292  9.919277
##  [6,]    241.9880 12.863445
##  [7,]    253.0603  9.167405
##  [8,]    259.1846  8.653282
##  [9,]    242.3805  9.832255
## [10,]    246.8435 11.135679</code></pre>
<p>If we set <code>nsim = 10000</code> and then took quantiles of the
resulting columns, we could get bootstrapped confidence limits on our
fixed effects. That’s what is happening when we do
<code>confint(ss.mm, method="boot")</code>. We want a function that
makes a prediction from a fitted model. Just using
<code>predict()</code> won’t work, because the function only takes one
argument, the fitted model. So we have to make a “wrapper” that will
call <code>predict()</code> with the right arguments.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>myFunc <span class="ot">&lt;-</span> <span class="cf">function</span>(mm){</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="co"># forgot the re.form argument on first try</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="fu">predict</span>(mm, <span class="at">newdata=</span>nd, <span class="at">re.form=</span><span class="sc">~</span><span class="dv">0</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>}</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="fu">myFunc</span>(ss.mm) <span class="co"># works</span></span></code></pre></div>
<pre><code>##        1        2        3        4        5        6        7        8 
## 251.4051 261.8724 272.3397 282.8070 293.2742 303.7415 314.2088 324.6761 
##        9       10 
## 335.1434 345.6107</code></pre>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># try with bootMer()</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>test <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(ss.mm, myFunc)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>test<span class="sc">$</span>t <span class="co">#works</span></span></code></pre></div>
<pre><code>##            1        2        3        4        5       6        7        8
## [1,] 256.399 265.7822 275.1654 284.5486 293.9318 303.315 312.6982 322.0814
##             9       10
## [1,] 331.4646 340.8478</code></pre>
<p>OK, this next bit takes a while … about 1 minute on my (old) home
computer</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>bigBoot <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(ss.mm, myFunc, <span class="at">nsim=</span><span class="dv">1000</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="fu">head</span>(bigBoot<span class="sc">$</span>t)</span></code></pre></div>
<pre><code>##             1        2        3        4        5        6        7        8
## [1,] 240.5466 250.0874 259.6282 269.1690 278.7099 288.2507 297.7915 307.3323
## [2,] 251.5451 261.2985 271.0518 280.8051 290.5585 300.3118 310.0651 319.8184
## [3,] 257.8782 268.9857 280.0932 291.2008 302.3083 313.4158 324.5233 335.6309
## [4,] 257.9161 267.2057 276.4954 285.7851 295.0748 304.3645 313.6542 322.9438
## [5,] 259.9344 272.1300 284.3256 296.5212 308.7168 320.9124 333.1080 345.3036
## [6,] 253.6331 263.4394 273.2457 283.0520 292.8583 302.6647 312.4710 322.2773
##             9       10
## [1,] 316.8732 326.4140
## [2,] 329.5718 339.3251
## [3,] 346.7384 357.8459
## [4,] 332.2335 341.5232
## [5,] 357.4992 369.6948
## [6,] 332.0836 341.8899</code></pre>
<p>Now we want quantiles of each column of that thing, turned around so
the columns are rows like the original <code>nd</code>.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># apply(xx, MARGIN = 2, FUN, ...) &#39;applies&#39; FUN to each column (because MARGIN = 2). arguments in ... get passed to FUN</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co"># t() transposes the result</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>predCL <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(bigBoot<span class="sc">$</span>t, <span class="at">MARGIN =</span> <span class="dv">2</span>, </span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>                  <span class="at">FUN =</span> quantile, </span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>                  <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.975</span>)))</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="co"># ggplot only works with data.frames so</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a><span class="co"># add to nd</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="co"># &#39;%&#39; in column names is a disaster so be explicit</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>nd<span class="sc">$</span>lci <span class="ot">&lt;-</span> predCL[,<span class="dv">1</span>]</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>nd<span class="sc">$</span>uci <span class="ot">&lt;-</span> predCL[,<span class="dv">2</span>]</span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>ssBase <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted, <span class="at">color=</span>Subject), <span class="at">data=</span>ss.fitted, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>PopPred), <span class="at">data=</span>nd, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>lci, <span class="at">ymax=</span>uci),</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/getQuantiles-1.png" width="672" /></p>
<p>So that’s pretty nice. I can add a geom_smooth() to show how much
wider the confidence intervals are compared to ignoring all the extra
variability.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>ssBase <span class="sc">+</span> <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted, <span class="at">color=</span>Subject),</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>                   <span class="at">data=</span>ss.fitted, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>PopPred), <span class="at">data=</span>nd, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  <span class="co"># set inherit.aes to FALSE here otherwise </span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>  <span class="co"># geom_ribbon looks for a y aesthetic </span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>  <span class="co"># called Reaction</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>lci, <span class="at">ymax=</span>uci),</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method=</span><span class="st">&quot;lm&quot;</span>, <span class="at">alpha=</span><span class="fl">0.8</span>, </span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a>              <span class="at">color=</span><span class="st">&quot;black&quot;</span>) <span class="sc">+</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="figure">
<img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/compareRibbons-1.png" alt="Reaction time as a function of days without sleep. Fine lines are subject level fits, thick line is population level prediction. The outer ribbon are bootstrapped 95% confidence limits. The inner ribbon is a 95% confidence limit ignoring between subject variation and random effects uncertainty." width="672" />
<p class="caption">
Reaction time as a function of days without sleep. Fine lines are
subject level fits, thick line is population level prediction. The outer
ribbon are bootstrapped 95% confidence limits. The inner ribbon is a 95%
confidence limit ignoring between subject variation and random effects
uncertainty.
</p>
</div>
<p>It is interesting that there isn’t much difference when Days == 0.
Note that you wouldn’t ever do this in practice! However, it might be
nice to build a few polygons at different levels of confidence.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>predCL <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">apply</span>(bigBoot<span class="sc">$</span>t, <span class="at">MARGIN =</span> <span class="dv">2</span>, </span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>                  <span class="at">FUN =</span> quantile, </span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>                  <span class="at">probs=</span><span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>, </span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>                          <span class="fl">0.1</span>, <span class="fl">0.9</span>, </span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>                          <span class="fl">0.25</span>, <span class="fl">0.75</span>)))</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co"># try making it into a dataframe</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>predCL <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(predCL)</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co"># names(predCL)</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co"># so puts a X at the front bc can&#39;t start with a number, </span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co"># and replaces % with . </span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co"># put them into nd</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">bind_cols</span>(nd, predCL)</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="co"># brute force multi-ribbons:</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>ssBase <span class="sc">+</span> </span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>.fitted, <span class="at">color=</span>Subject),</span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a>                   <span class="at">data=</span>ss.fitted, <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y=</span>PopPred), <span class="at">data=</span>nd, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>  <span class="co"># set inherit.aes to FALSE here otherwise </span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a>  <span class="co"># geom_ribbon looks for a y aesthetic </span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a>  <span class="co"># called Reaction</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>lci, <span class="at">ymax=</span>uci),</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a>  <span class="co"># add 90% ribbon</span></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>X5., <span class="at">ymax=</span>X95.),</span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>  <span class="co"># add 80% ribbon</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>X10., <span class="at">ymax=</span>X90.),</span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a>  <span class="co"># add 50% ribbon</span></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>Days, <span class="at">ymin=</span>X25., <span class="at">ymax=</span>X75.),</span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.2</span>) <span class="sc">+</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a></span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a>    <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<div class="figure">
<img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/multiRibbons-1.png" alt="Adding multiple transparent ribbons to match 95%, 90%, 80% and 50% confidence limits." width="672" />
<p class="caption">
Adding multiple transparent ribbons to match 95%, 90%, 80% and 50%
confidence limits.
</p>
</div>
<p>That doesn’t look as good as I’d hoped. The idea here is to draw the
eye closer to the expected value rather than the outer edges of the
confidence region.</p>
</div>
<div id="doing-it-with-a-glmm" class="section level2">
<h2>Doing it with a GLMM</h2>
<p>So now we want to redo the deer model from last lab.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>ecervi <span class="ot">&lt;-</span> ecervi <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Ecervi.pa =</span> Ecervi <span class="sc">&gt;</span> <span class="dv">0</span>,</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>         <span class="at">fSex =</span> <span class="fu">factor</span>(Sex, <span class="at">labels=</span><span class="fu">c</span>(<span class="st">&quot;Male&quot;</span>,<span class="st">&quot;Female&quot;</span>)),</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>         <span class="at">cLength =</span> Length <span class="sc">-</span> <span class="fu">mean</span>(Length),</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>         <span class="at">csLength =</span> cLength <span class="sc">/</span> <span class="fu">sd</span>(Length))</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="fu">contrasts</span>(ecervi<span class="sc">$</span>fSex) <span class="ot">&lt;-</span> <span class="fu">contr.sum</span>(<span class="dv">2</span>)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>M0 <span class="ot">&lt;-</span> <span class="fu">glmer</span>(Ecervi.pa<span class="sc">~</span>fSex<span class="sc">*</span>csLength<span class="sc">+</span>(<span class="dv">1</span> <span class="sc">+</span> csLength <span class="sc">|</span> Farm),</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>            <span class="at">data=</span>ecervi,<span class="at">family=</span>binomial)</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>lr <span class="ot">=</span> <span class="fu">range</span>(ecervi<span class="sc">$</span>csLength)</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>nd <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">csLength =</span> <span class="fu">seq</span>(lr[<span class="dv">1</span>], lr[<span class="dv">2</span>], <span class="at">length=</span><span class="dv">20</span>),</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>                  <span class="at">fSex=</span><span class="fu">factor</span>(<span class="fu">levels</span>(ecervi<span class="sc">$</span>fSex)))</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>nd<span class="sc">$</span>pp <span class="ot">=</span> <span class="fu">predict</span>(M0,<span class="at">newdata=</span>nd,</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>             <span class="at">type=</span><span class="st">&quot;response&quot;</span>, <span class="at">re.form=</span><span class="sc">~</span><span class="dv">0</span>)</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="fu">ggplot</span>(nd, <span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex)) <span class="sc">+</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>   <span class="fu">ylab</span>(<span class="st">&quot;Probability of E. cervi infection&quot;</span>) <span class="sc">+</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex), <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">linewidth=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>    <span class="fu">geom_rug</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength), <span class="at">data=</span><span class="fu">filter</span>(ecervi, Ecervi.pa),<span class="at">sides=</span><span class="st">&quot;t&quot;</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>  <span class="fu">geom_rug</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength), <span class="at">data=</span><span class="fu">filter</span>(ecervi, <span class="sc">!</span>Ecervi.pa),<span class="at">sides=</span><span class="st">&quot;b&quot;</span>, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>) <span class="sc">+</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>fSex) <span class="sc">+</span></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/unnamed-chunk-3-1.png" width="672" /></p>
<p>OK, now we want to do the bootstrap. But fitting this model already
is slow, so doing it 1000 times is even slower! Bootstrapping is one of
the things that benefits from parallel computing very easily. The bit of
code below sets up a “cluster” on my computer and splits the computation
up 4 ways. 4 times faster. Most modern CPU’s have multiple cores that
can run independently. In normal operation R uses just one core.
Depending on how many cores your computer has, running this code in
parallel could speed up this computation by a lot.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co"># Make the cluster</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>cl <span class="ot">&lt;-</span> <span class="fu">makeCluster</span>(<span class="dv">4</span>, <span class="at">type =</span> <span class="st">&quot;SOCK&quot;</span>)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co"># Export to the cluster</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="fu">clusterEvalQ</span>(cl, <span class="fu">library</span>(<span class="st">&quot;lme4&quot;</span>))</span></code></pre></div>
<pre><code>## [[1]]
##  [1] &quot;lme4&quot;      &quot;Matrix&quot;    &quot;snow&quot;      &quot;stats&quot;     &quot;graphics&quot;  &quot;grDevices&quot;
##  [7] &quot;utils&quot;     &quot;datasets&quot;  &quot;methods&quot;   &quot;base&quot;     
## 
## [[2]]
##  [1] &quot;lme4&quot;      &quot;Matrix&quot;    &quot;snow&quot;      &quot;stats&quot;     &quot;graphics&quot;  &quot;grDevices&quot;
##  [7] &quot;utils&quot;     &quot;datasets&quot;  &quot;methods&quot;   &quot;base&quot;     
## 
## [[3]]
##  [1] &quot;lme4&quot;      &quot;Matrix&quot;    &quot;snow&quot;      &quot;stats&quot;     &quot;graphics&quot;  &quot;grDevices&quot;
##  [7] &quot;utils&quot;     &quot;datasets&quot;  &quot;methods&quot;   &quot;base&quot;     
## 
## [[4]]
##  [1] &quot;lme4&quot;      &quot;Matrix&quot;    &quot;snow&quot;      &quot;stats&quot;     &quot;graphics&quot;  &quot;grDevices&quot;
##  [7] &quot;utils&quot;     &quot;datasets&quot;  &quot;methods&quot;   &quot;base&quot;</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">clusterExport</span>(cl, <span class="fu">list</span>(<span class="st">&quot;myFunc&quot;</span>, <span class="st">&quot;M0&quot;</span>, <span class="st">&quot;cl&quot;</span>))</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="co"># now we pass the cluster object to bootMer</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="co"># note that I can use the same myFunc!</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>bigBoot2 <span class="ot">&lt;-</span> <span class="fu">bootMer</span>(M0, myFunc, <span class="at">nsim =</span> <span class="dv">100</span>,</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>                    <span class="at">parallel =</span> <span class="st">&quot;snow&quot;</span>,</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>                    <span class="at">cl =</span> cl)</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a><span class="fu">stopCluster</span>(cl) <span class="co"># takes a long time ...</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co"># # Without running parallel</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="co"># bigBoot2 &lt;- bootMer(M0, myFunc, nsim=100)</span></span></code></pre></div>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># the object returned by bootMer is of type boot</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="co"># and there are some useful functions there.</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>envPred <span class="ot">&lt;-</span> boot<span class="sc">::</span><span class="fu">envelope</span>(bigBoot2)</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="fu">str</span>(envPred)</span></code></pre></div>
<pre><code>## List of 7
##  $ point  : num [1:2, 1:40] -0.75 -4.355 -0.528 -3.885 -0.306 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:40] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ overall: num [1:2, 1:40] -0.351 -4.511 -0.246 -3.972 -0.141 ...
##   ..- attr(*, &quot;dimnames&quot;)=List of 2
##   .. ..$ : NULL
##   .. ..$ : chr [1:40] &quot;1&quot; &quot;2&quot; &quot;3&quot; &quot;4&quot; ...
##  $ k.pt   : num [1:2] 2 99
##  $ err.pt : num [1:2] 0.0396 0.2376
##  $ k.ov   : num [1:2] 1 100
##  $ err.ov : num [1:2] 0.0198 0.1287
##  $ err.nom: num [1:2] 0.05 0.05</code></pre>
<p>The matrix <code>point</code> in there is the “pointwise” 95%
confidence intervals for each of the 40 rows in <code>nd</code>. The
error rate for those intervals is 5% on each value, which means that 24%
of the points will be outside the interval over the entire curve. The
matrix <code>overall</code> expands those limits until the number of
points over the entire curve is 5%. Time to add these to a plot. First
we have to get them into the nd data.frame.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>nd<span class="sc">$</span>lower.point <span class="ot">&lt;-</span> envPred<span class="sc">$</span>point[<span class="dv">1</span>,]</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>nd<span class="sc">$</span>upper.point <span class="ot">&lt;-</span> envPred<span class="sc">$</span>point[<span class="dv">2</span>,]</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="fu">ggplot</span>(nd, <span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex)) <span class="sc">+</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>   <span class="fu">ylab</span>(<span class="st">&quot;Probability of E. cervi infection&quot;</span>) <span class="sc">+</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex), <span class="at">data=</span>nd, <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, <span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">ymin=</span>lower.point, <span class="at">ymax=</span>upper.point, <span class="at">fill=</span>fSex), </span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>              <span class="at">data=</span>nd, <span class="at">inherit.aes=</span><span class="cn">FALSE</span>,</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.25</span>) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>fSex) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/plotEnvelope-1.png" width="672" /></p>
<p>OK. That’s not right! Look at the range, those values go from -5 to
nearly 8. They can’t be probabilities.</p>
<p>And in fact they aren’t. Back when we created <code>myFunc()</code>,
we just used <code>predict()</code> without specifying the argument
<code>type</code> (think back to Homework #1 <code>glm()</code> fits).
By default, <code>predict()</code> produces values on the link scale,
the scale of the linear predictor part of the model. But we want to plot
probabilities, so we have two choices.</p>
<ol style="list-style-type: decimal">
<li>change myFunc to use <code>type="response"</code> and rerun
<code>bootMer()</code></li>
<li>transform the link scale values to probabilities with the logistic
function.</li>
</ol>
<p>I’m going with (2), because it took a while to do (1) the first
time.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># boot::inv.logit() does the job</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>nd<span class="sc">$</span>lower.point <span class="ot">&lt;-</span> <span class="fu">inv.logit</span>(envPred<span class="sc">$</span>point[<span class="dv">1</span>,])</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>nd<span class="sc">$</span>upper.point <span class="ot">&lt;-</span> <span class="fu">inv.logit</span>(envPred<span class="sc">$</span>point[<span class="dv">2</span>,])</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="co"># Make the bootstrap object into a nice data.frame for ggplot</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>bigboot2_df <span class="ot">&lt;-</span> </span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>  <span class="fu">as.data.frame</span>(<span class="fu">apply</span>(bigBoot2<span class="sc">$</span>t, <span class="dv">1</span>, inv.logit)) <span class="sc">%&gt;%</span></span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a>  <span class="fu">cbind</span>(nd <span class="sc">%&gt;%</span> dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;csLength&quot;</span>, <span class="st">&quot;fSex&quot;</span>))) <span class="sc">%&gt;%</span></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">starts_with</span>(<span class="st">&quot;V&quot;</span>),</span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a>               <span class="at">names_to =</span> <span class="st">&quot;Sample&quot;</span>,</span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a>               <span class="at">values_to =</span> <span class="st">&quot;Estimate&quot;</span>)</span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a></span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a><span class="co"># Create a prediction with all bootstrap samples similar to Shipley et al. (2022)</span></span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb33-15"><a href="#cb33-15" tabindex="-1"></a>  <span class="co"># and don&#39;t forget to change alpha</span></span>
<span id="cb33-16"><a href="#cb33-16" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>lower.point, <span class="at">color=</span>fSex), </span>
<span id="cb33-17"><a href="#cb33-17" tabindex="-1"></a>              <span class="at">data=</span>nd, </span>
<span id="cb33-18"><a href="#cb33-18" tabindex="-1"></a>            <span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb33-19"><a href="#cb33-19" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb33-20"><a href="#cb33-20" tabindex="-1"></a>              <span class="at">inherit.aes=</span><span class="cn">FALSE</span>, </span>
<span id="cb33-21"><a href="#cb33-21" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb33-22"><a href="#cb33-22" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>upper.point, <span class="at">color=</span>fSex), </span>
<span id="cb33-23"><a href="#cb33-23" tabindex="-1"></a>              <span class="at">data=</span>nd, </span>
<span id="cb33-24"><a href="#cb33-24" tabindex="-1"></a>              <span class="at">linetype =</span> <span class="dv">2</span>,</span>
<span id="cb33-25"><a href="#cb33-25" tabindex="-1"></a>              <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb33-26"><a href="#cb33-26" tabindex="-1"></a>              <span class="at">inherit.aes=</span><span class="cn">FALSE</span>, </span>
<span id="cb33-27"><a href="#cb33-27" tabindex="-1"></a>              <span class="at">alpha=</span><span class="fl">0.75</span>) <span class="sc">+</span></span>
<span id="cb33-28"><a href="#cb33-28" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="at">data =</span> bigboot2_df,</span>
<span id="cb33-29"><a href="#cb33-29" tabindex="-1"></a>            <span class="fu">aes</span>(<span class="at">x =</span> csLength, <span class="at">y =</span> Estimate, <span class="at">group =</span> Sample),</span>
<span id="cb33-30"><a href="#cb33-30" tabindex="-1"></a>            <span class="at">color =</span> <span class="st">&quot;grey70&quot;</span>,</span>
<span id="cb33-31"><a href="#cb33-31" tabindex="-1"></a>            <span class="at">alpha =</span> <span class="fl">0.5</span>) <span class="sc">+</span> </span>
<span id="cb33-32"><a href="#cb33-32" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex),</span>
<span id="cb33-33"><a href="#cb33-33" tabindex="-1"></a>            <span class="at">data =</span> nd,</span>
<span id="cb33-34"><a href="#cb33-34" tabindex="-1"></a>            <span class="at">alpha=</span><span class="fl">0.5</span>) <span class="sc">+</span></span>
<span id="cb33-35"><a href="#cb33-35" tabindex="-1"></a>   <span class="fu">ylab</span>(<span class="st">&quot;Probability of E. cervi infection&quot;</span>) <span class="sc">+</span></span>
<span id="cb33-36"><a href="#cb33-36" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x=</span>csLength, <span class="at">y=</span>pp, <span class="at">col=</span>fSex), </span>
<span id="cb33-37"><a href="#cb33-37" tabindex="-1"></a>            <span class="at">data =</span> nd, </span>
<span id="cb33-38"><a href="#cb33-38" tabindex="-1"></a>            <span class="at">inherit.aes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb33-39"><a href="#cb33-39" tabindex="-1"></a>            <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb33-40"><a href="#cb33-40" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>fSex) <span class="sc">+</span></span>
<span id="cb33-41"><a href="#cb33-41" tabindex="-1"></a>  <span class="fu">guides</span>(<span class="at">color=</span><span class="cn">FALSE</span>, <span class="at">fill=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p><img src="05-C-Confidence-Intervals-Mixed-Models_files/figure-html/secondTry-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = false;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
